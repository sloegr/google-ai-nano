<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chrome Built-in AI Chatbot</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 50px auto;
        padding: 20px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        height: 700px;
        display: flex;
        flex-direction: column;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 20px;
      }

      .status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
      }

      .status.error {
        background-color: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .status.success {
        background-color: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      .status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .config-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .config-group {
        display: flex;
        flex-direction: column;
      }

      .config-group label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 600;
      }

      .config-group input {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .config-group textarea {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 12px;
        resize: vertical;
        font-family: inherit;
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        background: #fafafa;
      }

      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
      }

      .message.user {
        background: #4facfe;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.assistant {
        background: white;
        border: 1px solid #ddd;
        margin-right: auto;
      }
      .response-time {
        font-size: 11px;
        color: #888;
        margin-top: 5px;
        font-style: italic;
      }
      .message.system {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        font-style: italic;
        font-size: 13px;
        max-width: 100%;
        text-align: center;
      }

      .input-container {
        display: flex;
        gap: 10px;
      }

      #userInput {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        font-family: inherit;
      }

      button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .button-group button {
        flex: 1;
      }

      .helper-text {
        font-size: 11px;
        color: #666;
        margin-top: 3px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü§ñ Chrome AI Chatbot (Prompt API)</h1>

      <div id="status" class="status" style="display: none"></div>

      <div class="config-panel">
        <div class="config-group">
          <label for="systemPrompt">System Prompt (Optional):</label>
          <textarea
            id="systemPrompt"
            rows="2"
            placeholder="E.g., You are a helpful assistant..."
          >
You are a helpful AI assistant.</textarea
          >
          <div class="helper-text">Set the AI's behavior and personality</div>
        </div>
        <div class="config-group">
          <label for="temperature"
            >Temperature: <span id="tempValue">1.0</span></label
          >
          <input
            type="range"
            id="temperature"
            min="0"
            max="2"
            step="0.1"
            value="1.0"
          />
          <div class="helper-text">
            Higher = more creative, Lower = more focused
          </div>
        </div>
      </div>

      <div class="chat-container" id="chatContainer">
        <div class="message system">Checking API availability...</div>
      </div>

      <div class="input-container">
        <input
          type="text"
          id="userInput"
          placeholder="Type your message..."
          disabled
        />
        <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
      </div>

      <div class="button-group">
        <button id="initBtn" onclick="initializeSession()" disabled>
          Initialize Session
        </button>
        <button id="resetBtn" onclick="resetSession()" disabled>
          New Session
        </button>
        <button id="clearBtn" onclick="clearChat()" disabled>Clear Chat</button>
      </div>
    </div>

    <script>
      let session = null;
      let conversationHistory = [];
      let modelParams = null;

      const article_txt =
        "Leh: In a press conference immediately after the funeral of 46-year-old ex-serviceman Tsewang Tharchin, the Leh Apex Body (LAB) said that they will not resume talks with the Centre unless peace is restored in Ladakh.‚ÄúTill the time peace isn‚Äôt back we will not resume talks. MHA and the UT administration should do something to make things right and make this place peaceful and breathable again,‚Äù LAB Chairman Thupstan Chhewang told the media Monday. The ex-MP said the region has struggled for 70 years and then finally when it was granted UT status after the revocation of Article 370, it was without a legislature. ‚ÄúWe were forced to protest. Our demands are to be included in the Sixth Schedule, statehood and youth issues like job reservation and the setting up of a Public Service Commission). We get one parliamentary seat but the region requires two. This caused differences between the areas and people here,‚Äù the chairman added. He also said that the CRPF had resorted to ‚Äúgundagardi‚Äù and excessive force on 24 September, something that has never been witnessed before in Ladakh. ‚ÄúThe L-G in a press briefing had blamed us. They said that Nepalese and people from Doda were part of the protests. The DGP told the press that the protest had Pakistan influence and Sonam Wangchuk is an anti-national. We won‚Äôt tolerate this and we are hurt. If the government had held talks in time and fulfilled demands, this wouldn‚Äôt have happened. It worked like a pressure cooker,‚Äù Chering Dorjey, co-chairman of the Leh Apex Body and president of Ladakh Buddhist Association, said.‚ÄúWe don‚Äôt support violence but this is on the government. They are trying to make a tool kit accusing us of being anti-national and alleging that there is some Pakistan conspiracy behind this. If this was happening here, then what were the government agencies doing? Why did you wait till 24 September? Wangchuk has been on a hunger strike, protesting for a while. This is all baseless and the government is trying to hide its own faults and failures. We demand a judicial enquiry into the firing by a retired SC judge. We have proof that firing took place without a magistrate‚Äôs order or warning,‚Äù he added.A protester in hospital being treated for injuries sustained during clashes with security forces in Leh | Suraj Singh Bisht After the press conference, the Centre released a statement saying it was always open to dialogue with the LAB on matters relating to Ladakh. ‚ÄúWe would continue to welcome the discussion with the Leh Apex Body and Kargil Democratic Alliance through the High Powered Committee on Ladakh. It has yielded good results till date in the form of increased reservations for the Scheduled Tribes of Ladakh, providing women reservation in LAHDCs and protection to local languages. The process of recruitment for 1,800 posts in the government has already commenced in UT of Ladakh. We are confident that continuous dialogue would yield the desired results in the near future.‚ÄùAsked about the demands on the Sixth Schedule, Dorjey said, ‚ÄúWe rejoiced when Article 370 was removed because without it we wouldn‚Äôt have got UT status. We have been seeking UT status with the legislature for 70 years. Article 370 was an obstacle to get it. But now they have been delaying talks.‚ÄùDorjey also said that the government must revoke the ‚Äúfalse cases‚Äù filed against members and leaders of the apex body and release them. He also demanded that Wangchuk be released.‚ÄúLadakh has been so loyal to this country and this is what we get in return!‚Äù he said.Four people, including the ex-serviceman, died in Leh on 24 September after protesters and security forces clashed.(Edited by Viny Mishra) Also read: ‚ÄòCentre disrespected our patience, anger against BJP‚Äô‚Äîhow smolder turned into blaze in Ladakh";

      // Update temperature display
      document.getElementById("temperature").addEventListener("input", (e) => {
        document.getElementById("tempValue").textContent = e.target.value;
      });

      // Allow Enter key to send message
      document.getElementById("userInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Check if Prompt API is available
      async function checkAvailability() {
        const statusDiv = document.getElementById("status");
        const chatContainer = document.getElementById("chatContainer");

        // Check if LanguageModel exists
        if (!("LanguageModel" in self)) {
          statusDiv.textContent =
            "‚ùå Prompt API is not available. Please use Chrome 138+ and enable chrome://flags/#prompt-api-for-gemini-nano";
          statusDiv.className = "status error";
          statusDiv.style.display = "block";
          chatContainer.innerHTML =
            '<div class="message system">Prompt API not available on this browser.</div>';
          return false;
        }

        try {
          chatContainer.innerHTML =
            '<div class="message system">Checking model availability...</div>';

          // Get model parameters first
          modelParams = await LanguageModel.params();
          console.log("Model params:", modelParams);

          // Check availability
          const available = await LanguageModel.availability();
          console.log("Availability:", available);

          if (available === "unavailable") {
            statusDiv.textContent =
              "‚ùå Prompt API is unavailable on your device. Check hardware requirements.";
            statusDiv.className = "status error";
            statusDiv.style.display = "block";
            chatContainer.innerHTML =
              '<div class="message system">Model unavailable on this device.</div>';
            return false;
          } else if (available === "available") {
            statusDiv.textContent =
              '‚úì Prompt API is ready! Click "Initialize Session" to start.';
            statusDiv.className = "status success";
            statusDiv.style.display = "block";
            chatContainer.innerHTML =
              '<div class="message system">Click "Initialize Session" button below to start chatting.</div>';

            // Enable the initialize button
            document.getElementById("initBtn").disabled = false;
            return true;
          } else if (
            available === "downloadable" ||
            available === "downloading"
          ) {
            statusDiv.textContent =
              '‚ö†Ô∏è Model needs to be downloaded. Click "Initialize Session" to download and start.';
            statusDiv.className = "status warning";
            statusDiv.style.display = "block";
            chatContainer.innerHTML =
              '<div class="message system">Model needs download. Click "Initialize Session" to proceed (requires user action).</div>';

            // Enable the initialize button
            document.getElementById("initBtn").disabled = false;
            return true;
          }
        } catch (error) {
          console.error("Availability check error:", error);
          statusDiv.textContent = "‚ùå Error: " + error.message;
          statusDiv.className = "status error";
          statusDiv.style.display = "block";
          chatContainer.innerHTML =
            '<div class="message system">Error checking availability.</div>';
          return false;
        }
      }

      async function initializeSession() {
        // This function is called by user click, so we have a user gesture
        document.getElementById("initBtn").disabled = true;
        await createSession();

        // Hide the init button after successful creation
        if (session) {
          document.getElementById("initBtn").style.display = "none";
        }
      }

      async function createSession() {
        const chatContainer = document.getElementById("chatContainer");
        const statusDiv = document.getElementById("status");

        try {
          const systemPrompt = document
            .getElementById("systemPrompt")
            .value.trim();
          const temperature = parseFloat(
            document.getElementById("temperature").value
          );

          if (!modelParams) {
            modelParams = await LanguageModel.params();
          }

          // Fix topK: if defaultTopK is 0, use 3 as fallback
          const topKValue =
            modelParams.defaultTopK > 0 ? modelParams.defaultTopK : 3;

          const fullSystemPrompt = `You are an AI assistant. Answer questions based *only* on the provided article. Do not use external knowledge.
--- ARTICLE START ---
${article_txt}
--- ARTICLE END ---
User-defined behavior: ${systemPrompt}`;

          const options = {
            temperature: temperature,
            topK: topKValue,
            expectedOutputs: [{ type: "text", languages: ["en"] }],
            initialPrompts: [
              {
                role: "system",
                content: fullSystemPrompt, // ‚úÖ This includes your article_text
              },
            ],
            expectedInputs: [{ type: "text", languages: ["en"] }],
          };

          // Add system prompt if provided
          if (systemPrompt) {
            options.systemPrompt = systemPrompt;
            options.expectedInputs = [{ type: "text", languages: ["en"] }];
          }

          // Add download monitor
          options.monitor = (m) => {
            m.addEventListener("downloadprogress", (e) => {
              const percent = Math.round(e.loaded * 100);
              statusDiv.textContent = `‚ö†Ô∏è Downloading model: ${percent}%`;
              chatContainer.innerHTML = `<div class="message system">Downloading model: ${percent}%</div>`;
            });
          };

          console.log("Creating session with options:", options);

          // Destroy old session if exists
          if (session) {
            session.destroy();
          }

          // Create new session
          session = await LanguageModel.create(options);

          console.log("Session created successfully");
          statusDiv.textContent = "‚úì Session ready! Start chatting below.";
          statusDiv.className = "status success";
          chatContainer.innerHTML =
            '<div class="message system">Session ready! The article has been loaded into the model\'s context. You can now ask questions about it..</div>';

          // Enable inputs
          document.getElementById("userInput").disabled = false;
          document.getElementById("sendBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          document.getElementById("clearBtn").disabled = false;
          document.getElementById("userInput").focus();
        } catch (error) {
          console.error("Error creating session:", error);
          statusDiv.textContent =
            "‚ùå Session creation failed: " + error.message;
          statusDiv.className = "status error";
          chatContainer.innerHTML =
            '<div class="message system">Error: ' + error.message + "</div>";
        }
      }

      async function sendMessage() {
        const input = document.getElementById("userInput");
        const message = input.value.trim();

        if (!message) {
          alert("Please enter a message");
          return;
        }

        if (!session) {
          alert(
            "Session not ready. Please wait for initialization to complete."
          );
          return;
        }

        // Disable input while processing
        input.disabled = true;
        document.getElementById("sendBtn").disabled = true;

        // Add user message to chat
        addMessage("user", message);
        input.value = "";

        // Add thinking indicator
        const thinkingId = addMessage("assistant", "üí≠ Thinking...");

        try {
          const startTime = performance.now();
          // Get response from AI (maintains conversation context)
          const response = await session.prompt(message);

          const endTime = performance.now();
          const duration = endTime - startTime;

          // Remove thinking indicator and add actual response
          removeMessage(thinkingId);
          addMessage("assistant", response, duration);

          // Store in conversation history
          conversationHistory.push(
            { role: "user", content: message },
            { role: "assistant", content: response }
          );
        } catch (error) {
          console.error("Error getting response:", error);
          removeMessage(thinkingId);
          addMessage("system", "Error: " + error.message);
        } finally {
          input.disabled = false;
          document.getElementById("sendBtn").disabled = false;
          input.focus();
        }
      }

      function addMessage(role, content, duration) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        const messageId = "msg-" + Date.now() + "-" + Math.random();

        messageDiv.id = messageId;
        messageDiv.className = `message ${role}`;
        messageDiv.textContent = content;

        // Add the response time if provided for the assistant's final message
        if (role === "assistant" && duration !== null) {
          const timeDiv = document.createElement("div");
          timeDiv.className = "response-time";
          timeDiv.textContent = `(Responded in ${duration}ms)`;
          messageDiv.appendChild(timeDiv);
        }
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return messageId;
      }

      function removeMessage(messageId) {
        const message = document.getElementById(messageId);
        if (message) {
          message.remove();
        }
      }

      async function resetSession() {
        if (
          confirm(
            "Start a new session? This will clear the conversation context."
          )
        ) {
          document.getElementById("userInput").disabled = true;
          document.getElementById("sendBtn").disabled = true;
          await createSession();
          conversationHistory = [];
          addMessage("system", "New session started with updated settings!");
        }
      }

      function clearChat() {
        if (
          confirm("Clear the chat display? (Session context will be preserved)")
        ) {
          const chatContainer = document.getElementById("chatContainer");
          chatContainer.innerHTML =
            '<div class="message system">Chat cleared. Session context maintained.</div>';
        }
      }

      // Initialize on page load
      window.addEventListener("load", async () => {
        await checkAvailability();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (session) {
          session.destroy();
        }
      });
    </script>
  </body>
</html>
